<!doctype html>
<html lang="tr">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>SmartRAG - Multiple Document Upload</title>
	<style>
		body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',sans-serif;margin:40px;color:#0f172a;background:#f8fafc}
		.card{max-width:720px;margin:auto;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.05)}
		.header{padding:20px 24px;border-bottom:1px solid #e5e7eb;font-weight:600}
		.content{padding:24px}
		label{display:block;margin-bottom:8px;color:#334155}
		input[type=file]{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px}
		button{margin-top:16px;background:#2563eb;color:#fff;border:none;border-radius:8px;padding:10px 16px;cursor:pointer}
		pre{background:#0b1220;color:#e2e8f0;padding:12px;border-radius:8px;overflow:auto}
	</style>
</head>
<body>
	<div class="card">
		<div class="header">Multiple Document Upload</div>
		<div class="content">
			<label for="files">Files (you can select multiple files)</label>
			<input id="files" type="file" name="files" multiple />
			<button id="send">Upload</button>
			<div id="result" style="margin-top:16px"></div>
			
			<!-- Console Logs -->
			<div style="margin-top: 24px; border-top: 1px solid #e5e7eb; padding-top: 16px;">
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
					<strong>Console Logs (Real-time)</strong>
					<div style="display: flex; gap: 8px;">
						<select id="logFilter" style="padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 12px;">
							<option value="all">All Logs</option>
							<option value="sse">SSE Only</option>
							<option value="upload">Upload Only</option>
							<option value="error">Errors Only</option>
						</select>
						<button id="clearLogs" style="background: #6b7280; padding: 4px 8px; font-size: 12px;">Clear</button>
					</div>
				</div>
				<div id="consoleLogs" style="background: #0f172a; color: #e2e8f0; padding: 12px; border-radius: 8px; height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4;"></div>
			</div>
		</div>
	</div>
	<script>
		const btn = document.getElementById('send');
		const input = document.getElementById('files');
		const result = document.getElementById('result');
		const consoleLogs = document.getElementById('consoleLogs');
		const clearLogsBtn = document.getElementById('clearLogs');
		const logFilter = document.getElementById('logFilter');
		
		// Console log yakalama
		const MAX_LOGS = 100; // Maksimum log sayƒ±sƒ±
		const LOG_CLEANUP_THRESHOLD = 50; // Temizleme e≈üiƒüi
		
		function addLog(message, type = 'info', category = 'upload') {
			const timestamp = new Date().toLocaleTimeString();
			const logEntry = document.createElement('div');
			logEntry.style.marginBottom = '4px';
			logEntry.setAttribute('data-category', category);
			
			let color = '#e2e8f0'; // default
			if (type === 'error') color = '#fca5a5';
			else if (type === 'warning') color = '#fcd34d';
			else if (type === 'success') color = '#86efac';
			
			logEntry.innerHTML = `<span style="color: #94a3b8;">[${timestamp}]</span> <span style="color: ${color};">${message}</span>`;
			consoleLogs.appendChild(logEntry);
			
			// Performans optimizasyonu: Eski loglarƒ± temizle
			if (consoleLogs.children.length > MAX_LOGS) {
				cleanupOldLogs();
			}
			
			consoleLogs.scrollTop = consoleLogs.scrollHeight;
			
			// Browser console'a da log ekle
			const consoleMessage = `[SmartRAG] ${message}`;
			if (type === 'error') console.error(consoleMessage);
			else if (type === 'warning') console.warn(consoleMessage);
			else console.log(consoleMessage);
		}
		
		// Eski loglarƒ± temizle
		function cleanupOldLogs() {
			const logsToRemove = consoleLogs.children.length - LOG_CLEANUP_THRESHOLD;
			for (let i = 0; i < logsToRemove; i++) {
				if (consoleLogs.firstChild) {
					consoleLogs.removeChild(consoleLogs.firstChild);
				}
			}
		}
		
		// Clear logs
		clearLogsBtn.onclick = () => {
			consoleLogs.innerHTML = '';
			addLog('Logs cleared', 'info');
		};
		
		// Log filtreleme
		logFilter.onchange = () => {
			applyLogFilter();
		};
		
		function applyLogFilter() {
			const filterValue = logFilter.value;
			const logEntries = consoleLogs.children;
			
			for (let i = 0; i < logEntries.length; i++) {
				const entry = logEntries[i];
				const category = entry.getAttribute('data-category') || 'upload';
				
				let shouldShow = true;
				
				switch (filterValue) {
					case 'sse':
						shouldShow = category === 'sse';
						break;
					case 'upload':
						shouldShow = category === 'upload';
						break;
					case 'error':
						shouldShow = entry.textContent.includes('‚ùå') || entry.textContent.includes('error');
						break;
					case 'all':
					default:
						shouldShow = true;
						break;
				}
				
				entry.style.display = shouldShow ? 'block' : 'none';
			}
		}
		
		// SSE Log Stream baƒülantƒ±sƒ±
		let eventSource;
		
		function connectToLogStream() {
			try {
				addLog('Connecting to SSE log stream...', 'info');
				eventSource = new EventSource('/api/logs/stream');
				
				eventSource.onmessage = function(event) {
					try {
						const logData = JSON.parse(event.data);
						const level = logData.level?.toLowerCase() || 'info';
						const message = logData.message || event.data;
						
						// Log seviyesine g√∂re renk belirle
						let color = '#e2e8f0'; // default
						if (level === 'error') color = '#fca5a5';
						else if (level === 'warning') color = '#fcd34d';
						else if (level === 'success') color = '#86efac';
						else if (level === 'debug') color = '#94a3b8';
						
						addLog(`[SSE] ${message}`, level, 'sse');
					} catch (parseError) {
						addLog(`[SSE] Parse error: ${parseError.message}`, 'error');
					}
				};
				
				eventSource.onerror = function(error) {
					addLog(`SSE connection error: ${error.type}`, 'error');
					// Reconnect after 5 seconds
					setTimeout(connectToLogStream, 5000);
				};
				
				eventSource.onopen = function() {
					addLog('SSE log stream connected successfully!', 'success');
				};
				
			} catch (error) {
				addLog(`Failed to connect to SSE: ${error.message}`, 'error');
			}
		}
		
		// SSE baƒülantƒ±sƒ±nƒ± ba≈ülat
		connectToLogStream();
		
		// Sayfa kapatƒ±ldƒ±ƒüƒ±nda SSE baƒülantƒ±sƒ±nƒ± temizle
		window.addEventListener('beforeunload', function() {
			if (eventSource) {
				eventSource.close();
			}
		});
		
		// Initial log
		addLog('Upload page ready', 'success');
		
		btn.onclick = async () => {
			const files = input.files;
			if (!files || files.length === 0) { 
				result.innerHTML = '<div style="color: #dc2626;">‚ùå Please select files.</div>'; 
				addLog('No files selected', 'error');
				return; 
			}
			
			addLog(`${files.length} files selected`, 'info');
			
			// Disable button and show loading
			btn.disabled = true;
			btn.textContent = 'Uploading...';
			result.innerHTML = `<div style="color: #059669;">‚è≥ ${files.length} files uploading...</div>`;
			
			const form = new FormData();
			for (const f of files) {
				form.append('files', f);
				addLog(`Adding file: ${f.name} (${(f.size / 1024).toFixed(1)} KB)`, 'info');
			}
			
			addLog('Sending to API...', 'info');
			
			try {
				const res = await fetch('/api/Documents/upload-multiple', { method: 'POST', body: form });
				
				if (res.ok) {
					const data = await res.json();
					addLog(`‚úÖ ${files.length} files uploaded successfully!`, 'success');
					
					result.innerHTML = `
						<div style="color: #059669; margin-bottom: 12px;">‚úÖ ${files.length} files uploaded successfully!</div>
						<div style="margin-bottom: 8px;"><strong>Uploaded Files:</strong></div>
						<ul style="margin: 0; padding-left: 20px;">
							${data.map(doc => `<li>${doc.fileName} (ID: ${doc.id})</li>`).join('')}
						</ul>
					`;
					
					// Log each uploaded document
					data.forEach(doc => {
						addLog(`üìÑ ${doc.fileName} uploaded (ID: ${doc.id})`, 'success');
					});
					
				} else {
					const errorText = await res.text();
					addLog(`‚ùå API Error: ${res.status} ${res.statusText}`, 'error');
					addLog(`Error Details: ${errorText}`, 'error');
					
					result.innerHTML = `
						<div style="color: #dc2626;">‚ùå Error: ${res.status} ${res.statusText}</div>
						<pre style="background: #fef2f2; color: #dc2626; padding: 8px; border-radius: 4px; margin-top: 8px;">${errorText}</pre>
					`;
				}
			} catch (e) { 
				addLog(`‚ùå Network Error: ${e.message}`, 'error');
				result.innerHTML = `<div style="color: #dc2626;">‚ùå Upload failed: ${e.message}</div>`; 
			} finally {
				// Re-enable button
				btn.disabled = false;
				btn.textContent = 'Upload';
				addLog('Upload process completed', 'info');
			}
		};
	</script>
</body>
</html>
